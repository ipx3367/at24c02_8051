#include<reg52.h>
#include <intrins.h>
#include <stdio.h>


#define uchar unsigned char
#define uint unsigned int
	
bit  write=0;           //写24C02的标志；
sbit sda=P1^0;                         
sbit scl=P1^1;

uchar code chn_word[] =
{
0xF7,0xFB,0x80,0xFE,0xFE,0xC0,0xFE,0xFE,0x00,0xFE,0xFE,0x80,0xFD,0xFB,0xE7,0x1F,
0xDF,0xBF,0x03,0xFF,0xFF,0x07,0xFF,0xFF,0x01,0xFF,0xFF,0x03,0x7F,0xBF,0xCF,0xF1,
0xC0,0xFF,0xC1,0xDD,0xCD,0xD4,0xFF,0xC0,0xDD,0xC0,0xDD,0xC0,0xD7,0xD0,0xB7,0x70,
0x81,0xFF,0x83,0xBB,0x9B,0xAB,0x7F,0x03,0xBF,0x07,0xB7,0x07,0xBB,0x87,0xBD,0xC1,
0xFD,0xFD,0xFB,0xF7,0xEF,0xDF,0x80,0xDF,0xFF,0xE0,0xEF,0xEF,0xEF,0xEF,0xE0,0xEF,
0xFF,0xFF,0xFF,0xDF,0xEF,0xF7,0x03,0xFB,0xFF,0x0F,0xEF,0xEF,0xEF,0xEF,0x0F,0xEF,
0xBB,0xD7,0xD1,0x7B,0xB5,0xB1,0xFF,0xD5,0xDF,0xB8,0x3F,0xB8,0xBB,0xB8,0xBF,0xFF,
0xBB,0x17,0xF1,0x1B,0xF5,0x11,0x5F,0x15,0xFF,0x07,0xF7,0x07,0xFF,0x03,0xFB,0xC7,
0xFF,0x81,0xFB,0xD7,0xEF,0xC3,0x3B,0xFB,0xC2,0xDF,0xBE,0x83,0xFB,0xFB,0xD7,0xEE,
0x6F,0x5F,0xBB,0xD7,0xEF,0x07,0x69,0x6F,0xF3,0xFF,0x07,0xF7,0x2F,0xDF,0xAF,0x77,
0xFF,0xFE,0x02,0xEE,0xEE,0xEE,0xEE,0x82,0xEE,0xEE,0xEE,0xEF,0xE3,0x1F,0xBE,0xFD,
0xFF,0x03,0xFB,0xFB,0x03,0xFB,0xFB,0x03,0xFB,0xFB,0x03,0xAF,0x6F,0x6D,0xED,0xF1,
0xFD,0xFE,0x80,0xFF,0xE0,0xEF,0xE0,0xFF,0x80,0xBF,0x70,0xF7,0xF7,0xEF,0xDF,0x3F,
0xFF,0xFF,0x03,0xFF,0x0F,0xEF,0x0F,0xFF,0x01,0xFD,0x1B,0xDF,0xDF,0xDD,0xDD,0xE1,
0xFF,0x01,0x6D,0x29,0x45,0x6D,0x01,0xEF,0x01,0xEF,0xE1,0x1F,0xFD,0x55,0x57,0x7F,
0xEF,0xEF,0xEF,0xEF,0xE1,0xEF,0xEF,0xEF,0x01,0x7D,0x7D,0x7D,0x7D,0x7D,0x01,0x7D
};


void delay()
{ ;; }

void Delayms(unsigned char tm)		//@11.0592MHz
{
	unsigned char i, j;
	
	while(tm--)
	{
		_nop_();
		i = 2;
		j = 199;
		do
		{
			while (--j);
		} while (--i);
		
	}	
}


void delay1ms(uint z)
{
	uint x,y;
	for(x=z;x>0;x--)
		for(y=110;y>0;y--);
}


void InitUART(void)
{
	SCON=0x50;
	TMOD=0x20;
	TH1=0xfd;
	TR1=1;
	PCON=0x00;
	EA=1;
	ES=1;
	
	// for printf() use 
	RI=TI=1;
}

void start()  //开始信号
{	
	sda=1;
	delay();
	scl=1;
	delay();
	sda=0;
	delay();
}
void stop()   //停止
{
	sda=0;
	delay();
	scl=1;
	delay();
	sda=1;
	delay();
}
void respons()  //应答
{
	uchar i;
	scl=1;
	delay();
	while((sda==1)&&(i<250))i++;
	scl=0;
	delay();
}
void init()
{
	sda=1;
	delay();
	scl=1;
	delay();
}
void write_byte(uchar date)
{
	uchar i,temp;
	temp=date;
	for(i=0;i<8;i++)
	{
		temp=temp<<1;
		scl=0;
	    delay();
		sda=CY;
		delay();
		scl=1;
		delay();
	}
	scl=0;
	delay();
	sda=1;
	delay();
}
uchar read_byte()
{
	uchar i,k;
	scl=0;
	delay();
	sda=1;
	delay();
	for(i=0;i<8;i++)
	{
		scl=1;
		delay();	
		k=(k<<1)|sda;
		scl=0;
		delay();	
	}
	return k;
}
void write_add(uchar address,uchar date)
{
	start();
	write_byte(0xa0);
	respons();
	write_byte(address);
	respons();
	write_byte(date);
	respons();
	stop();
}
uchar read_add(uchar address)
{
	uchar date;
	start();
	write_byte(0xa0);
	respons();
	write_byte(address);
	respons();
	start();
	write_byte(0xa1);
	respons();
	date=read_byte();
	stop();
	return date;
}



void main()
{

	uint i;
	uint val;
	
	InitUART();
	init();
	
	//
	Delayms(250);
	Delayms(250);
	Delayms(250);
	printf("write the AT24C02 EEPROM .....");
	write_add(0,99); 
	
	for(i=0;i<=255;i++)
	{
		printf(" %d : write data.\n",i);
		write_add(i,chn_word[i]); 
		Delayms(40);
		
	}
	
	

	while(1)
	{
		for(i=0;i<=255;i++)
		{
			val = read_add(i);
			printf("address %x value is:%x \n",i, val);
			Delayms(100);
		}

		
	}
	
	
	
}




